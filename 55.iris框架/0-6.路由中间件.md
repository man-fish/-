# 中间件

当我们在 iris 中讨论中间件的时候，我们就是在讨论运行一个 HTTP 请求处理器前后的代码。例如，日志中间件会把即将到来的请求明细写到日志中，然后在写响应日志详细之前，调用处理期代码。比较酷的是这些中间件是松耦合，而且可重用。

中间件仅仅是 `func(ctx iris.Context)` 的处理器形式，中间件在前一个调用 `ctx.Next()` 时执行，这个可以用于去认证，例如，如果登录了，调用  `ctx.Next()` 否则将触发一个错误响应。

## 中间件开发

```php
package main

import "github.com/kataras/iris"

func main() {
    app := iris.New()
    app.Get("/", before, mainHandler, after)
    app.Run(iris.Addr(":8080"))
}

func before(ctx iris.Context) {
    shareInformation := "this is a sharable information between handlers"

    requestPath := ctx.Path()
    println("Before the mainHandler: " + requestPath)

    ctx.Values().Set("info", shareInformation)
    ctx.Next() // 执行下一个处理器。
}

func after(ctx iris.Context) {
    println("After the mainHandler")
}

func mainHandler(ctx iris.Context) {
    println("Inside mainHandler")

    // 获取 "before" 处理器中的设置的 "info" 值。
    info := ctx.Values().GetString("info")

    // 响应客户端
    ctx.HTML("<h1>Response</h1>")
    ctx.HTML("<br/> Info: " + info)

    ctx.Next() // execute the "after".
}
$ go run main.go # and navigate to the http://localhost:8080
Now listening on: http://localhost:8080
Application started. Press CTRL+C to shut down.
Before the mainHandler: /
Inside mainHandler
After the mainHandler
```

### 全局

```php
package main

import "github.com/kataras/iris"

func main() {
    app := iris.New()
        // 注册 "before"  处理器作为当前域名所有路由中第一个处理函数
        // 或者使用  `UseGlobal`  去注册一个中间件，用于在所有子域名中使用
    app.Use(before)
        // 注册  "after" ，在所有路由的处理程序之后调用
    app.Done(after)

    // 注册路由
    app.Get("/", indexHandler)
    app.Get("/contact", contactHandler)

    app.Run(iris.Addr(":8080"))
}

func before(ctx iris.Context) {
     // [...]
}

func after(ctx iris.Context) {
    // [...]
}

func indexHandler(ctx iris.Context) {
    // 响应客户端
    ctx.HTML("<h1>Index</h1>")

    ctx.Next() // 执行通过 `Done` 注册的 "after" 处理器。
}

func contactHandler(ctx iris.Context) {
    // 响应客户端
    ctx.HTML("<h1>Contact</h1>")

    ctx.Next() // 执行通过 `Done` 注册的 "after" 处理器。
}
```

### 路由组内全局

```
package user

import (
	"fmt"
	"github.com/kataras/iris"
)

func UserHandlerParty(user iris.Party) {
	user.Use(userAuthMiddlewareHandler)
    //中间件函数
	user.Get("/profile", userProfileHandler)
    //路由API函数
}

func userAuthMiddlewareHandler(ctx iris.Context) {
	fmt.Printf("校验成功:%v",ctx.Path())
	ctx.Next()
}

func userProfileHandler(ctx iris.Context){
	ctx.HTML("<h1>peter 8d</h1>")
}
```

## 探索

下面你将看到一些有用的处理程序的源代码：

| Middleware                                             | Example                                                      |
| ------------------------------------------------------ | ------------------------------------------------------------ |
| [基本认证](https://docs.iris-go.com/basicauth)         | [iris/_examples/authentication/basicauth](https://github.com/kataras/iris/tree/master/_examples/authentication/basicauth) |
| [Google reCAPTCHA](https://docs.iris-go.com/recaptcha) | [iris/_examples/miscellaneous/recaptcha](https://github.com/kataras/iris/tree/master/_examples/miscellaneous/recaptcha) |
| [本地化和国际化](https://docs.iris-go.com/i18n)        | [iris/_examples/miscellaneous/i81n](https://github.com/kataras/iris/tree/master/_examples/miscellaneous/i18n) |
| [请求记录器](https://docs.iris-go.com/logger)          | [iris/_examples/http_request/request-logger](https://github.com/kataras/iris/tree/master/_examples/http_request/request-logger) |
| [性能分析 (pprof)](https://docs.iris-go.com/pprof)     | [iris/_examples/miscellaneous/pprof](https://github.com/kataras/iris/tree/master/_examples/miscellaneous/pprof) |
| [恢复](https://docs.iris-go.com/recover)               | [iris/_examples/miscellaneous/recover](https://github.com/kataras/iris/tree/master/_examples/miscellaneous/recover) |

一些确实能帮到你的中间件：

| Middleware                                                   | Description                                                  | Example                                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [jwt](https://github.com/iris-contrib/middleware/tree/master/jwt) | 检查请求的 `Authorization` 头， 进行 JWT 检查和解析          | [iris-contrib/middleware/jwt/_example](https://github.com/iris-contrib/middleware/tree/master/jwt/_example) |
| [cors](https://github.com/iris-contrib/middleware/tree/master/cors) | HTTP 跨域请求。                                              | [iris-contrib/middleware/cors/_example](https://github.com/iris-contrib/middleware/tree/master/cors/_example) |
| [secure](https://github.com/iris-contrib/middleware/tree/master/secure) | 一些快速安全实现的中间件。                                   | [iris-contrib/middleware/secure/_example](https://github.com/iris-contrib/middleware/tree/master/secure/_example/main.go) |
| [tollbooth](https://github.com/iris-contrib/middleware/tree/master/tollboothic) | 用于验证 HTTP 请求速率的通用中间件                           | [iris-contrib/middleware/tollbooth/_examples/limit-handler](https://github.com/iris-contrib/middleware/tree/master/tollbooth/_examples/limit-handler) |
| [cloudwatch](https://github.com/iris-contrib/middleware/tree/master/cloudwatch) | AWS cloudwatch 指标中间件。                                  | [iris-contrib/middleware/cloudwatch/_example](https://github.com/iris-contrib/middleware/tree/master/cloudwatch/_example) |
| [new relic](https://github.com/iris-contrib/middleware/tree/master/newrelic) | 官方 [New Relic Go Agent](https://github.com/newrelic/go-agent). | [iris-contrib/middleware/newrelic/_example](https://github.com/iris-contrib/middleware/tree/master/newrelic/_example) |
| [prometheus](https://github.com/iris-contrib/middleware/tree/master/prometheus) | 轻松为 [prometheus](http://prometheus.io/) 检测工具创建指标端点 | [iris-contrib/middleware/prometheus/_example](https://github.com/iris-contrib/middleware/tree/master/prometheus/_example) |
| [casbin](https://github.com/iris-contrib/middleware/tree/master/casbin) | 支持各种权限模型的授权库，例如 ACL， RBAC， ABAC             | [iris-contrib/middleware/casbin/_examples](https://github.com/iris-contrib/middleware/tree/master/casbin/_examples) |